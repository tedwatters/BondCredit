CREATE TABLE main_n_index

SELECT 
	a.DEFAULTED, 
    a.TENDER_EXCH_OFFER, 
    a.ANNOUNCED_CALL, 
    a.ACTIVE_ISSUE, 
    a.BOND_TYPE, 
    a.ISIN, 
    a.ACTION_TYPE, 
    a.EFFECTIVE_DATE, 
    a.CROSS_DEFAULT, 
    a.RATING_DECLINE_TRIGGER_PUT, 
    a.RATING_DECLINE_PROVISION, 
    a.FUNDED_DEBT_IS, 
    a.INDEBTEDNESS_IS, 
    a.FUNDED_DEBT_SUB, 
    a.INDEBTEDNESS_SUB, 
    a.CUSIP_NAME, 
    a.INDUSTRY_GROUP, 
    a.INDUSTRY_CODE, 
    a.ESOP, 
    a.IN_BANKRUPTCY, 
    a.PARENT_ID, 
    a.NAICS_CODE, 
    a.COUNTRY_DOMICILE, 
    a.SIC_CODE, 
    a.ISSUE_ID, 
    a.RATING_TYPE, 
    a.RATING_DATE, 
    a.RATING, 
    a.RATING_STATUS, 
    a.REASON, 
    a.RATING_STATUS_DATE, 
    a.INVESTMENT_GRADE, 
    a.ISSUER_ID, 
    a.PROSPECTUS_ISSUER_NAME, 
    a.ISSUER_CUSIP, 
    a.ISSUE_CUSIP, 
    a.ISSUE_NAME, 
    a.MATURITY, 
    a.OFFERING_DATE, 
    a.COMPLETE_CUSIP,
	count(b.RATING_DATE)+1 AS N_INDEX
FROM      
	main a LEFT JOIN main b ON a.RATING_DATE>b.RATING_DATE AND a.COMPLETE_CUSIP = b.COMPLETE_CUSIP AND a.RATING_TYPE = b.RATING_TYPE


GROUP BY
	a.DEFAULTED, 
    a.TENDER_EXCH_OFFER, 
    a.ANNOUNCED_CALL, 
    a.ACTIVE_ISSUE, 
    a.BOND_TYPE, 
    a.ISIN, 
    a.ACTION_TYPE, 
    a.EFFECTIVE_DATE, 
    a.CROSS_DEFAULT, 
    a.RATING_DECLINE_TRIGGER_PUT, 
    a.RATING_DECLINE_PROVISION, 
    a.FUNDED_DEBT_IS, 
    a.INDEBTEDNESS_IS, 
    a.FUNDED_DEBT_SUB, 
    a.INDEBTEDNESS_SUB, 
    a.CUSIP_NAME, 
    a.INDUSTRY_GROUP, 
    a.INDUSTRY_CODE, 
    a.ESOP, 
    a.IN_BANKRUPTCY, 
    a.PARENT_ID, 
    a.NAICS_CODE, 
    a.COUNTRY_DOMICILE, 
    a.SIC_CODE, 
    a.ISSUE_ID, 
    a.RATING_TYPE, 
    a.RATING_DATE, 
    a.RATING, 
    a.RATING_STATUS, 
    a.REASON, 
    a.RATING_STATUS_DATE, 
    a.INVESTMENT_GRADE, 
    a.ISSUER_ID, 
    a.PROSPECTUS_ISSUER_NAME, 
    a.ISSUER_CUSIP, 
    a.ISSUE_CUSIP, 
    a.ISSUE_NAME, 
    a.MATURITY, 
    a.OFFERING_DATE, 
    a.COMPLETE_CUSIP;